{% extends 'base.html' %}
{% block title %}
    Search Results - Cartblanche22
{% endblock %}
{% block styles %}
{{ super() }}
<style>
   .mol {
   opacity: 1;
   border: 1px solid #ccc;
   border-radius: 4px;
   margin-bottom: 20px;
   text-align: center;
   background-color: white;
   }
   .link {
   padding: 10px;
   }
   .mol img {
   width: 100%;
   height: 15vh
   }
   .added {
   {#border: 1px solid #5bc0de;#}
   background-color: #9bd8eb;
   }
   
   .my-auto{
    display: flex;
    align-items: center; /* Vertical center alignment */
    justify-content: center; /* Horizontal center alignment */
   }

   .pagination{
    margin: 0px;
   }


</style>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="../static/js/custom/api.js"></script>
<script>
    let pageLimit = 48;
    let currentPage = 0;
    let lastPage = 100000;
    function copyToClipboard(){
            navigator.clipboard.writeText(missing22);
    }

   $(document).ready(() => {
        var bar = document.getElementById('progress');
        bar.setAttribute("aria-valuenow", 100);
        bar.style.width = "100%";
        bar.innerHTML= "Processing...";
        let map22 = new Map();
        let map20 = new Map();
        let progressRequest = null;

        $(function(){
            $("[data-toggle=popover]").popover({
                html : true,

                content: function() {
                    var content = $(this).attr("data-popover-content");
                    return $(content).children(".popover-body").html();
                },
                title: function() {
                    var title = $(this).attr("data-popover-content");
                    return $(title).children(".popover-heading").html();
                }
            });
        }); 

        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        });
        
       
        function showTable(){
            const template22 = 
                {"<>":"div","class":"col-xs-6 col-sm-4 col-md-3 col-lg-2 col-xl-2","html": [
                    {"<>":"div", class:"mol", "html":[
                        {"<>":"div", class:"link", "html":[
                                {"<>":"a", href:"/substance/${zinc_id}", "text":"${zinc_id}"
                            }]
                        },
                        {"<>":"div", class:"mol-bottom zinc22", id:"${zinc_id}", "data-smiles":"${smiles}", "data-db":"zinc22", "data-supplier_code":"${supplier_code }", "data-catalogs":"${catalogs}",
                            "html":[
                                {"<>":"img", "src":"https://sw.docking.org/depict/svg?w=50&h=30h&smi=${smiles_url}&qry=%q&cols=%c&cmap=%m&bgcolor=clear&hgstyle=outerglow"}]
                        },
                        ]
                    }]
                };    
            $('.data22').html(json2html.render(datas22.slice(pageLimit*currentPage,(pageLimit*currentPage)+pageLimit),template22));

            const template20 = 
                {"<>":"div","class":"col-xs-6 col-sm-4 col-md-3 col-lg-2 col-xl-2","html": [
                    {"<>":"div", class:"mol", "html":[
                        {"<>":"div", class:"link", "html":[
                                {"<>":"a", href:"/substance/${zinc_id}", "text":"${zinc_id}"
                            }]
                        },
                        {"<>":"div", class:"mol-bottom zinc20", id:"${zinc_id}", "data-smiles":"${smiles}", "data-db":"zinc20", "data-supplier_code":"${supplier_code }", "data-catalogs":"${catalogs}",
                            "html":[
                                {"<>":"img", "src":"https://sw.docking.org/depict/svg?w=50&h=30h&smi=${smiles_url}&qry=%q&cols=%c&cmap=%m&bgcolor=clear&hgstyle=outerglow"}]
                        },
                        ]
                    }]
                };    
            $('.data20').html(json2html.render(datas20.slice(pageLimit*currentPage,(pageLimit*currentPage)+pageLimit),template20));

            addAddedClass();
            $('.mol-bottom').click((e) => {        
                let cur = $(e.currentTarget);
                let id = e.currentTarget.id;
                let cur_data;
                if (map22.has(id)){
                    cur_data = map22.get(id)
                }
                else{
                    cur_data = map20.get(id)
                }
                let db = cur.data('db')
                let smiles = cur_data.smiles
                let supplier_code = cur_data.supplier_code
                let catalogs = cur_data.catalogs
                if (cur.hasClass('added')) {
                    cur.removeClass('added')
                    shoppingCart.removeItemFromCart(id)
                } else {
                    cur.addClass('added')
                    shoppingCart.addItemToCart(id, db, smiles, supplier_code, catalogs);
                }
            });

            lastPage = parseInt(datas22.length / pageLimit);
            if(lastPage === 0){
                document.getElementById("pageSelector").style.display = "none";
            }
            else{
                document.getElementById("pageSelector").style.display = "";
            }
        }

        function insertAfter(newNode, existingNode) {
            existingNode.parentNode.insertBefore(newNode, existingNode.nextSibling);
        }

        $('select').change(function() {
            pageLimit = this.value;
            changePage(0);
        });

        function changePage(num){
            currentPage = num;

            if(num >= lastPage){
                currentPage = lastPage;
            }
            if(num < 0){
                currentPage = 0;
            }
            
            var page_numbers = document.getElementById('page_numbers');
            var init = document.getElementById('previousPage');
            
            
            $('.number').remove();
            
            for(let i = currentPage + 2; i > currentPage - 4; i --){
                element = document.createElement("li");
             
              
                if( (i >= 0) && (i < lastPage+1)){
              
                    element.classList.add("page-item");
                    element.classList.add("number");
                    element.setAttribute("page-number", i+1);
                    element.id = "pageNumber";
                    if(i === currentPage){
                        element.classList.add("active");
                    }
                    button = document.createElement("a");
                    button.classList.add("page-link");
                    button.href = "#";
                    button.innerHTML = i+1;
                        
                    element.appendChild(button);
                    insertAfter(element, init);
                }
            }

            $('.number').click((e) => {
                changePage(parseInt(e.currentTarget.getAttribute("page-number"))-1);
            });

            showTable();
        }


        function addAddedClass(){
            let count = 0;
            
            if (datas22.length > 0){
                $('#zinc22-tab').click();
            }
            else if(datas20.length > 0){
                $('#zinc20-tab').click();
            }

            if (datas22.length > 0){
                var tab = document.getElementById('zinc22-tab');
                tab.style.display = "block";
                datas22.forEach(e => {
                    
                    map22.set(e.zinc_id, e)
                    let inCart = shoppingCart.inCart(e.zinc_id)
                    if (inCart) {
                        count++;
                        $('#' + e.zinc_id).addClass('added')
                    }
                    
                });
            }
            if (datas20.length > 0){
                var tab = document.getElementById('zinc20-tab');
                tab.style.display = "block";
                datas20.forEach(e => {
                    map20.set(e.zinc_id, e)
                    let inCart = shoppingCart.inCart(e.zinc_id)
                    if (inCart) {
                        count++;
                        $('#' + e.zinc_id).addClass('added')
                    }
                })
            }
            
            
            if (count > datas22.length / 2) {
                $('#deleteAll22').show();
                $('#addAll22').hide();
            } else {
                $('#addAll22').show();
                $('#deleteAll22').hide();
            }
            if (count > datas20.length / 2) {
                $('#deleteAll20').show();
                $('#addAll20').hide();
                
            } else {
                $('#addAll20').show();
                $('#deleteAll20').hide();
            }
        };

        function get_progress(){
            $.ajax({
                url: "/search/progress?task="+params.task,
                async: true,
                statusCode: {
                    404: function() {
                        location.reload();
                    }
                },
                success : function(result){
                            console.log(result)
                            if(result.ready === 'true'){
                                clearInterval(progressRequest);
                                
                                var bar = document.getElementById('search_progress');
                                bar.style.display = "none";
                                
                                datas22 = result.data22;
                                missing22 = result.missing22;
                                datas20 = result.data20;
                                searchLogs = result.logs;

                                lastPage = parseInt(datas22.length / pageLimit);
                                document.getElementById("22resultcount").innerHTML = datas22.length + " results"; 
                                document.getElementById("20resultcount").innerHTML = datas20.length + " results";

                                if (datas22 == null){
                                    datas22 = []
                                }
                                if (datas20 == null){
                                    datas20 = []
                                }

                                if(searchLogs.length !== 0){
                                    $('#searchLogs').html(searchLogs.join('\n'));
                                }

                                if(missing22.length !== 0){
                                    document.getElementById("22missingcount").style.display = "";
                                    document.getElementById("22missingcount").innerHTML = missing22.length + " not found";
                                    $('#missing-list').html(missing22.join('\n'));
                                }  
                                addAddedClass();
                                changePage(0);
                            
                            }
                            else{
                                progress = Math.round(result.progress*100);
                                
                                if(progress > 0){
                                    var bar = document.getElementById('progress');
                                    bar.setAttribute("aria-valuenow", progress);
                                    bar.style.width = progress+"%";
                                    bar.innerHTML= progress+"%";
                                }   
                            }
               
                }
             });            
        }
        
        let ready = {{ready}};
        if(ready === true){
            datas22 = {{ data22 | tojson }};
            missing22 = {{missing22 | tojson}};
            datas20 = {{ data20 | tojson}};
            searchLogs = {{logs | tojson}};

            document.getElementById("22resultcount").innerHTML = datas22.length + " results"; 
            document.getElementById("20resultcount").innerHTML = datas20.length + " results";

            if (datas22 == null){
                datas22 = []
            }
            if (datas20 == null){
                datas20 = []
            }
            
            if(searchLogs.length !== 0){
                $('#searchLogs').html(searchLogs.join("\n"));
            }
            
            if(missing22.length !== 0){
                console.log(missing22)
                document.getElementById("22missingcount").style.display = "";
                document.getElementById("22missingcount").innerHTML = missing22.length + " not found";
                $('#missing-list').html(missing22.join('\n'));
            }
            
            addAddedClass();
            changePage(0);
        }
        else{
            var bar = document.getElementById('search_progress');
            bar.style.display = "block";
            progressRequest = setInterval(get_progress, 500);     
        }

        $('#firstPage').click(() => {
            changePage(0);
        });

        $('#lastPage').click(() => {
            changePage(lastPage);
        });

        $('#nextPage').click(() => {
            changePage(currentPage+1);
        });

        $('#previousPage').click(() => {
            changePage(currentPage-1);
        });

        $('#addAll22').click(() => {
            shoppingCart.addAllItem(datas22);
            datas22.forEach(e => {
                $('#' + e.zinc_id).addClass('added')
            })
            $('#addAll22').hide();
            $('#deleteAll22').show();
        });

        $('#deleteAll22').click(() => {
            shoppingCart.deleteAllItem(datas22);
            $('.added.zinc22').removeClass('added');
            $('#addAll22').show();
            $('#deleteAll22').hide();
        });

        $('#addAll20').click(() => {
            shoppingCart.addAllItem(datas20);
            datas20.forEach(e => {
                    $('#' + e.zinc_id).addClass('added')
            })
            $('#addAll20').hide();
            $('#deleteAll20').show();
        });

        $('#deleteAll20').click(() => {
            shoppingCart.deleteAllItem(datas20);
            $('.added.zinc20').removeClass('added');
            $('#addAll20').show();
            $('#deleteAll20').hide();
        });
   });
</script>
{% endblock %}

{% block search_results %}

<div class="hidden" id="a1">
  <div class="popover-heading">
    Missing Results
  </div>

  <div class="popover-body">
    <button class="btn btn-primary" onclick="copyToClipboard()">Copy to Clipboard</button>
    <br>
    <br>
    <div id="missing-list" aria-describedby="Not found"></div>
  </div>
</div>

<ul class="nav nav-tabs" id="myTab" role="tablist">
  <li class="nav-item">
    <a class="nav-link" style="display:none;" id="zinc22-tab" data-toggle="tab" href="#zinc22" role="tab" aria-controls="zinc22" aria-selected="true">ZINC22 results</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" style="display:none;" id="zinc20-tab" data-toggle="tab" href="#zinc20" role="tab" aria-controls="zinc20" aria-selected="false">ZINC20 results</a>
  </li>
</ul>
<br>
<div class="tab-content " id="myTabContent">
    <div id="search_progress" style="display:none;">
        <div>
            <h3>Search Progress</h3>
        </div>
        <div class="progress active">
            <div id="progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="100" aria-valuemax="100">Processing.\.\.</div>
        </div>
    </div>

   <div class="tab-pane fade active" id="zinc22" role="tabpanel" aria-labelledby="zinc22-tab">
      <div class="row h-100">
         <div class="col-md-4 col-xs-4 col-sm-4 col-lg-4">
            <button type="button" class="btn btn-primary" id="22resultcount" disabled> </button>
            <button type="button" class="btn btn-outline-danger" data-placement="right" data-popover-content="#a1" data-toggle="popover" id="22missingcount" style="display:none;" ></button>
         </div>
                 
         <div class="col-md-4 col-xs-4 col-sm-4 col-lg-4 float-right text-right">
            <div class="nav" aria-label="Page navigation">
               <ul class="pagination" id="pageSelector">
                 <li class="page-item" id="firstPage">
                    <a class="page-link" href="#" aria-label="First">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>   
                  </li>
                  <li class="page-item" id="previousPage" >
                    <a class="page-link" href="#" aria-label="Last">
                        <span aria-hidden="true"><</span>
                        <span class="sr-only">Next</span>
                    </a>  
                  </li>
                  <li class="page-item" id="nextPage" >
                    <a class="page-link" href="#" aria-label="Last">
                        <span aria-hidden="true">></span>
                        <span class="sr-only">Next</span>
                    </a>  
                  </li>
                  
                  <li id ="lastPage" class="page-last">
                    <a class="page-link" href="#" aria-label="Last">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Last</span>
                    </a>  
                  </li>
               </ul>
            </div>
         </div>
         <div class="col-md-2 col-xs-2 col-sm-2 col-lg-2 float-right my-auto">
            Show&nbsp;
            <select id="page-limit" style="width: 50%;" class="form-control">
            <option>50</option>
            <option>100</option>
            <option>250</option>
            <option>500</option>
            </select>
            
         </div>
         
            
            <div class="col-md-2 col-xs-2 col-sm-2 col-lg-2 float-right text-right my-auto">
                <button class="btn btn-primary dropdown-toggle" type="button" id="download-results" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-download"></i>
            
                </button>
                <ul class="dropdown-menu" aria-labelledby="download-results">
                <li><a href="/search/result.json?task={{task}}" download="results.json">json</a></li>
                <li><a href="/search/result.csv?task={{task}}" download="results.csv">csv</a></li>
                <li><a href="/search/result.txt?task={{task}}" download="results.txt">txt</a></li>
                </ul>
                &nbsp;
              
                <button type="button" class="btn btn-info" id="addAll22">add all to cart</button>
                <button type="button" class="btn btn-warning" id="deleteAll22">remove all from cart</button>
            </div>
      </div>
   </div>
   <br>
   <div class="row data22">
      
   </div>
</div>
  <div class="tab-pane fade" id="zinc20" role="tabpanel" aria-labelledby="zinc20-tab">
    <div class="row h-100">
         <div class="col-md-3 col-xs-3 col-sm-3 col-lg-4">
            <button type="button" class="btn btn-primary" id="20resultcount" disabled> </button>
         </div>
                 
         <div class="col-md-3 col-xs-3 col-sm-3 col-lg-4 float-right text-right">
            <div class="nav" aria-label="Page navigation">
               <ul class="pagination" id="pageSelector">
                 <li class="page-item" id="firstPage">
                    <a class="page-link" href="#" aria-label="First">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>   
                  </li>
                  <li class="page-item" id="previousPage" >
                    <a class="page-link" href="#" aria-label="Last">
                        <span aria-hidden="true"><</span>
                        <span class="sr-only">Next</span>
                    </a>  
                  </li>
                  <li class="page-item" id="nextPage" >
                    <a class="page-link" href="#" aria-label="Last">
                        <span aria-hidden="true">></span>
                        <span class="sr-only">Next</span>
                    </a>  
                  </li>
                  
                  <li id ="lastPage" class="page-last">
                    <a class="page-link" href="#" aria-label="Last">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Last</span>
                    </a>  
                  </li>
               </ul>
            </div>
         </div>
         <div class="col-md-3 col-xs-3 col-sm-3 col-lg-2 float-right">
            <div class="row">
                
            <div class="col-md-3 col-xs-3 col-sm-3 col-lg-12 my-auto">Show:&nbsp;
                <select id="page-limit" style="width: 40%;" class="form-control">
                <option>50</option>
                <option>100</option>
                <option>250</option>
                <option>500</option>
                </select></div>
            </div>
         </div>
         <div class="col-md-6 col-xs-9 col-sm-9 col-lg-2 float-right text-right">
         <button type="button" class="btn btn-info" id="addAll20">add all results to cart</button>
         <button type="button" class="btn btn-warning" id="deleteAll20">remove all results from cart</button>
      </div>
    </div>
   
    <br>
    <div class="row data20">
      
    </div>
  </div>
</div>
</div>

{%  if request.access_route[-1][0:3] == '10.' or  request.access_route[-1][0:8] == '169.230.' or request.access_route[-1][0:8] == '128.218.' %}                                
    <div class="container fixed-bottom">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingOne">
                <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        Search Logs
                    </a>
                </h4>
                </div>
                <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                <div class="panel-body">
                    <textarea id="searchLogs" class="form-control" type="text" placeholder="Sea…" readonly></textarea>
                </div>
                </div>
            </div>                            
        </div>
    </div>
{%  endif %}

{% endblock %}
