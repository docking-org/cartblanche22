{% extends 'base.html' %}
{% block styles %}
    {{ super() }}
    <style>

        .div-tranche {
            max-width: 80em;
            max-height: 40em;
            overflow: scroll;
            position: relative;
        }

        table {
            position: relative;
            borderborder-collapse: collapse;
        {#: 1px solid black;#}
        }

        th {
            padding: 0.5em;

        }

        td {
            border: 1px solid #ccc;
            padding: 0.5em;
        }

        thead th:first-child {
            left: 0;
            z-index: 1;
            border: none;
        }

        thead th {
            position: -webkit-sticky;
            /* for Safari */
            position: sticky;
            top: 0;
            background: grey;
            color: #FFF;
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            opacity: 0.8;
            margin-top: 0;
        }

        thead th.enabled {
            opacity: 1;
        }

        thead th:last-child {
            right: 0;
            z-index: 1;
        }

        tbody th {
            position: -webkit-sticky;
            /* for Safari */
            position: sticky;
            left: 0;
            background: grey;
            color: white;
            opacity: 0.8;
            border-bottom: 1px solid #ccc;
            border-top: 1px solid #ccc;

            border-right: 1px solid #ccc;

        }

        tbody th.enabled {
            opacity: 1;
        }

        tbody td:last-child {
            position: -webkit-sticky;
            /* for Safari */
            position: sticky;
            right: 0;
            background-color: grey;
            color: white;
            text-align: center;

        }

        tfoot th {
            position: -webkit-sticky;
            /* for Safari */
            position: sticky;
            bottom: 0;
            background: grey;
            color: #FFF;
            border-right: 1px solid #ccc;
            border-left: 1px solid #ccc;

        }

        tfoot th:first-child {
            left: 0;
            z-index: 1;
            border: none;
        }

        tfoot th:last-child {
            right: 0;
            z-index: 1;

        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: grey;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #ccc;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }


    </style>

{% endblock %}
{% block scripts %}
    {{ super() }}
    <script>
        let scope = new Object();
        scope.cells = new Array(62).fill(new Array(62).fill(0));

        $(document).ready(function () {
            let arr = {{ cell2D | safe }};
            let log_total = Math.log({{ unfilteredSize }})
            scope.log_total = Math.log({{ unfilteredSize }})
            let rowSize = new Array(62).fill(0);
            let colSize = new Array(62).fill(0);
            let totalSize = 0
            for (let i = 0; i < 62; i++) {
                for (let j = 0; j < 62; j++) {
                    scope.cells[i][j] = arr[i][j]
                    rowSize[i] += arr[i][j];
                    colSize[j] += arr[i][j];
                    totalSize += arr[i][j];
                    let cell = $('#' + i + '-' + j)
                    cell.html(arr[i][j])
                    let color = (Math.floor(255 - 255 * (log_total - 1.1 * Math.log(arr[i][j])) / log_total));

                    cell.css('background-color', '#' + color.toString(16).repeat(3));
                    cell.css('color', color > 105 ? '#333' : '#ccc');
                    if (cell.hasClass("enabled")) {
                        cell.css('opacity', 1.0)
                    } else {
                        cell.css('opacity', 0.1)
                    }
                }
            }
            for (let i = 0; i < 62; i++) {
                $('#row-' + i).html(rowSize[i])
                $('#col-' + i).html(colSize[i])
            }
            $('#tranche-total').html(totalSize)
            scope.rowSize = rowSize
            scope.colSize = colSize
            scope.totalSize = totalSize
            scope.cells = arr;
        });

        function renderTable(){
             let rowSize = new Array(62).fill(0);
            let colSize = new Array(62).fill(0);
            let totalSize = 0
        for (let i = 0; i < 62; i++) {
                for (let j = 0; j < 62; j++) {
                    let cell = $('#' + i + '-' + j)
                     if (cell.hasClass('enabled')) {
                        rowSize[i] += scope.cells[i][j];
                        colSize[j] += scope.cells[i][j];
                        totalSize += scope.cells[i][j];
                        cell.css('opacity', 1.0)
                    } else {
                        cell.css('opacity', 0.1)
                    }
                    cell.html(scope.numberToggle ? bigNumber(scope.cells[i][j]) : scope.cells[i][j])
                }
            }

         for (let i = 0; i < 62; i++) {
                $('#row-' + i).html(scope.numberToggle ? bigNumber(rowSize[i]) :rowSize[i])
                $('#col-' + i).html(scope.numberToggle ? bigNumber(colSize[i]) : colSize[i])
            }
         $('#tranche-total').html(scope.numberToggle ? bigNumber(totalSize) :totalSize)
        }

        function colToggle(o) {
            let col = $('#' + o.id)
            let id = col.data('id')
            if (col.hasClass('enabled')) {
                for (let i = 0; i < 62; i++) {
                    let cell = $('#' + i + '-' + id)
                    cell.removeClass('enabled')
                }
                col.removeClass('enabled')
            } else {
                for (let i = 0; i < 62; i++) {
                    let cell = $('#' + i + '-' + id)
                    cell.addClass('enabled')
                }
                col.addClass('enabled')
            }
            renderTable()
        }

        function rowToggle(o) {
            let row = $('#' + o.id)
            let id = row.data('id')
            if (row.hasClass('enabled')) {
                for (let i = 0; i < 62; i++) {
                    let cell = $('#' + id + '-' + i)
                    cell.removeClass('enabled')
                }
                row.removeClass('enabled')
            } else {
                for (let i = 0; i < 62; i++) {
                    let cell = $('#' + id + '-' + i)
                    cell.addClass('enabled')
                }
                row.addClass('enabled')
            }
            renderTable()
            {#o.stopPropagation();#}
        }

        function cellToggle(o) {
            let cell = $('#' + o.id)
            if (cell.hasClass("enabled")) {
                cell.removeClass("enabled")
            } else {
                cell.addClass('enabled')
            }
            renderTable()
        }

        function calculate() {
            let arr = {{ cell2D | safe }};
            let rowSize = new Array(62).fill(0);
            let colSize = new Array(62).fill(0);
            let totalSize = 0
            for (let i = 0; i < 62; i++) {
                for (let j = 0; j < 62; j++) {
                    let cell = $('#' + i + '-' + j)
                    if (cell.hasClass('enabled')) {
                        rowSize[i] += arr[i][j];
                        colSize[j] += arr[i][j];
                        totalSize += arr[i][j];
                        cell.css('opacity', 1.0)
                    } else {
                        cell.css('opacity', 0.1)
                    }
                }
            }
            for (let i = 0; i < 62; i++) {
                $('#row-' + i).html(rowSize[i])
                $('#col-' + i).html(colSize[i])
            }
            $('#tranche-total').html(totalSize)
        }
        function numberToggles(btn) {
            scope.numberToggle = $(btn).prop('checked');
            renderTable();
        }
        function bigNumber(input){
             if(input >= 10000000) {
               return '' + Math.round(input / 1000000) + 'M';
           } else if(input >= 1000000) {
               return '' + Math.round(input / 100000) / 10 + 'M';
           } else if (input >= 10000) {
               return '' + Math.round(input / 1000)  + 'K';
           } else if (input >= 1000) {
               return '' + Math.round(input / 100) / 10 + 'K';
           } else {
               return input;
           }
        }

    </script>
{% endblock %}
{% block app_content %}
    <div>
        <label class="switch">
            <input type="checkbox" id="numberToggle" onclick="numberToggles(this)">
            <span class="slider round"></span>
        </label>
    </div>
    <div class="div-tranche">
        <table>
            <thead>
            <tr>
                <th class="enabled"></th>
                {% for cell in ticks[0] %}
                    <th class="enabled" onclick="colToggle(this)" id="th-col-{{ cell }}"
                        data-id={{ cell }}>{{ axes[2][cell] }}.{{ axes[0][cell] }}</th>
                {% endfor %}
                <th class="enabled">Totals, by logp</th>
            </tr>
            </thead>
            <tbody>
            {% for row in ticks[0] %}
                <tr>
                    <th class="enabled" id="th-row-{{ row }}" onclick="rowToggle(this)"
                        data-id={{ row }}>{{ axes[2][row] }}.{{ axes[1][row] }}</th>
                    {% for col in ticks[0] %}
                        <td id='{{ row }}-{{ col }}' class="enabled row-{{ row }} col-{{ col }}"
                            onclick="cellToggle(this)">{{ row, col }}</td>
                    {% endfor %}
                    <td id="row-{{ row }}">Sum {{ row }}</td>
                </tr>
            {% endfor %}

            </tbody>
            <tfoot>
            <tr>
                <th>Totals, by HAC</th>
                {% for col in ticks[0] %}
                    <th id="col-{{ col }}">sum {{ axes[0][col] }}</th>
                {% endfor %}
                <th id="tranche-total">all sum</th>

            </tr>
            </tfoot>
        </table>
    </div>

{% endblock %}