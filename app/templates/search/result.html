{% extends 'base.html' %}
{% block styles %}
{{ super() }}
<style>
   .mol {
   opacity: 1;
   border: 1px solid #ccc;
   border-radius: 4px;
   margin-bottom: 20px;
   text-align: center;
   background-color: white;
   }
   .link {
   padding: 10px;
   }
   .mol img {
   width: 100%;
   height: 15vh
   }
   .added {
   {#border: 1px solid #5bc0de;#}
   background-color: #9bd8eb;
   }
</style>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    let pageLimit = 50;
    let currentPage = 0;
    
   $(document).ready(() => {
        $(function () {
          $('[data-toggle="popover"]').popover()
        })
       let datas22 = {{ data22 | tojson }};
       let missing22 = {{ missing22 | tojson }};
       let datas20 = {{ data20 | tojson}};
       
       let lastPage = parseInt(datas22.length / pageLimit);
       console.log(lastPage);
   
       if (datas22 == null){
           datas22 = []
       }
       if (datas20 == null){
           datas20 = []
       }
       let map22 = new Map();
       let map20 = new Map();
       addAddedClass();

       function showTable(){
        const template = 
            {"<>":"div","class":"col-xs-6 col-sm-4 col-md-3 col-lg-2 col-xl-2","html": [
                {"<>":"div", class:"mol", "html":[
                    {"<>":"div", class:"link", "html":[
                            {"<>":"a", href:"/searchZinc/${zinc_id}", "text":"${zinc_id}"
                        }]
                    },
                    {"<>":"div", class:"mol-bottom zinc22", id:"${zinc_id}", "data-smiles":"${smiles}", "data-db":"zinc22", "data-supplier_code":"${supplier_code }", "data-catalogs":"${catalogs}",
                        "html":[
                            {"<>":"img", "src":"https://sw.docking.org/depict/svg?w=50&h=30h&smi=${smiles_url}&qry=%q&cols=%c&cmap=%m&bgcolor=clear&hgstyle=outerglow"}]
                    },
                    ]
                }]
            };

            $('.data22').html(json2html.render(datas22.slice(pageLimit*currentPage,(pageLimit*currentPage)+pageLimit),template));
       }

       showTable();

       $('.mol-bottom').click((e) => {
           
           let cur = $(e.currentTarget);
           let id = e.currentTarget.id;
           let cur_data;
           if (map22.has(id)){
               cur_data = map22.get(id)
           }
           else{
               cur_data = map20.get(id)
           }
           let db = cur.data('db')
           let smiles = cur_data.smiles
           let supplier_code = cur_data.supplier_code
           let catalogs = cur_data.catalogs
           if (cur.hasClass('added')) {
               cur.removeClass('added')
               shoppingCart.removeItemFromCart(id)
           } else {
               cur.addClass('added')
               shoppingCart.addItemToCart(id, db, smiles, supplier_code, catalogs);
           }
       })

       $('#addAll22').click(() => {
           shoppingCart.addAllItem(datas22);
           {#addAddedClass();#}
            datas22.forEach(e => {
                $('#' + e.zinc_id).addClass('added')
           })
           $('#addAll22').hide();
           $('#deleteAll22').show();
       });
   
       $('#deleteAll22').click(() => {
           shoppingCart.deleteAllItem(datas22);
           $('.added.zinc22').removeClass('added');
           $('#addAll22').show();
           $('#deleteAll22').hide();
       });
        $('#addAll20').click(() => {
           shoppingCart.addAllItem(datas20);
           {#addAddedClass();#}
             datas20.forEach(e => {
                $('#' + e.zinc_id).addClass('added')
           })
           $('#addAll20').hide();
           $('#deleteAll20').show();
       });
   
       $('#deleteAll20').click(() => {
           shoppingCart.deleteAllItem(datas20);
           $('.added.zinc20').removeClass('added');
           $('#addAll20').show();
           $('#deleteAll20').hide();
       });


   
       function changePage(){
   
       }
   
       function addAddedClass(){
           let count = 0;
           
           if (datas22.length > 0){
               $('#zinc22-tab').click();
           }
           else if(datas20.length > 0){
               $('#zinc20-tab').click();
           }
   
           if (datas22.length > 0){
               datas22.forEach(e => {
                   map22.set(e.zinc_id, e)
                   let inCart = shoppingCart.inCart(e.zinc_id)
                   if (inCart) {
                       count++;
                       $('#' + e.zinc_id).addClass('added')
                   }
                
               });
           }
           if (datas20.length > 0){
              
   
              datas20.forEach(e => {
                   map20.set(e.zinc_id, e)
                   let inCart = shoppingCart.inCart(e.zinc_id)
                   if (inCart) {
                       count++;
                       $('#' + e.zinc_id).addClass('added')
                   }
               })
           }
         
          
           if (count > datas22.length / 2) {
               $('#deleteAll22').show();
               $('#addAll22').hide();
           } else {
               $('#addAll22').show();
               $('#deleteAll22').hide();
           }
           if (count > datas20.length / 2) {
               $('#deleteAll20').show();
               $('#addAll20').hide();
               
           } else {
               $('#addAll20').show();
               $('#deleteAll20').hide();
           }
       };
       
       /* function update_progress() {
           // send GET request to status URL
   
           $.ajax({
               url: "/searchJob?task=bfcdd260-5056-4b3a-960f-9f9cd81ca8d8",
               type: "get",
           
               success: function(response) {
                   datas22 = response;
               },
               error: function(xhr) {
                   //Do Something to handle error
               }
            });
       } */

   });
</script>
{% endblock %}
{% block app_content %}
<ul class="nav nav-pills nav-tabs" id="myTab" role="tablist">
   {% if data22 %}
   <li class="nav-item">
      <a class="nav-link" id="zinc22-tab" data-toggle="tab" href="#zinc22" role="tab" aria-controls="zinc22" aria-selected="true">ZINC22 results</a>
   </li>
   {%  endif %}
   {%  if data20 %}
   <li class="nav-item">
      <a class="nav-link" id="zinc20-tab" data-toggle="tab" href="#zinc20" role="tab" aria-controls="zinc20" aria-selected="false">ZINC20 results</a>
   </li>
   {%  endif %}
</ul>
<div class="tab-content" id="myTabContent">
{% if data22 %}
   <div class="tab-pane fade active" id="zinc22" role="tabpanel" aria-labelledby="zinc22-tab">
      <div class="row">
         <div class="col-md-3 col-xs-3 col-sm-3 col-lg-1">
            <br>
            <button type="button" class="btn btn-primary" disabled>{{ data22|length }} results</button>
         </div>
         <div class="col-md-3 col-xs-3 col-sm-3 col-lg-3">
            <br>
            <button type="button" class="btn btn-outline-danger" data-toggle="popover" title="Not Found" data-content="{{missing22 | join('\n')}}">{{ missing22|length }} not found</button>
            
         </div>
         
         <div class="col-md-3 col-xs-3 col-sm-3 col-lg-5 float-right text-right">
            <nav aria-label="Page navigation example">
               <ul class="pagination">
                  <li class="page-item"><a class="page-link" href="#">Previous</a></li>
                  {% for i in range(4) %}
                    <li class="page-item"><a class="page-link" href="#">{{i+1}}</a></li>
                  {%endfor%}
                  <li class="page-item"><a class="page-link" href="#">Next</a></li>
                  <li class="page-ellipsis"><a class="page-link" href="#">Last</a></li>
                  <li class="page-last"><a class="page-link" href="#">Last</a></li>
               </ul>
            </nav>
         </div>
         <div class="col-md-3 col-xs-3 col-sm-3 col-lg-2 float-right">
            <br>
            <select class="form-control">
                <option>50</option>
                <option>100</option>
                <option>250</option>
                <option>500</option>
                <option>All</option>
            </select>
         </div>
      
      <div class="col-md-6 col-xs-9 col-sm-9 col-lg-1 float-right text-right">
        <br>
         <button type="button" class="btn btn-info" id="addAll22">Add all to cart</button>
         <button type="button" class="btn btn-warning" id="deleteAll22">Remove all from cart</button>
      </div>
   </div>
   <br>
   <div class="row data22">
      
   </div>
</div>
{% endif %}
{% if data20 %}
<div class="tab-pane fade" id="zinc20" role="tabpanel" aria-labelledby="zinc20-tab">
   <div class="row">
      <div class="col-md-6 col-xs-3 col-sm-3 col-lg-6">
         <h3> {{ data20|length }} results</h3>
      </div>
      <div class="col-md-6 col-xs-9 col-sm-9 col-lg-6 float-right text-right">
         <button type="button" class="btn btn-info" id="addAll20">Add all to cart</button>
         <button type="button" class="btn btn-warning" id="deleteAll20">Remove all from cart</button>
      </div>
   </div>
   <div class="row">
      {% for data in data20 %}
      <div class="col-xs-6 col-sm-4 col-md-3 col-lg-2 col-xl-2">
         <div class="mol ">
            <div class="link">
               <a href='/searchZinc20/{{ data.zinc_id }}'>{{ data.zinc_id }}</a>
            </div>
            <div class="mol-bottom zinc20" id="{{ data.zinc_id }}" data-smiles="{{ data.smiles }}" data-db="zinc20"
               data-supplier_code="{{ data.supplier_code }}" data-catalogs="{{ data.catalogs }}">
               <img src="https://sw.docking.org/depict/svg?w=50&h=30h&smi={{ data.smiles | urlencode }}&qry=%q&cols=%c&cmap=%m&bgcolor=clear&hgstyle=outerglow">
            </div>
         </div>
      </div>
      {% endfor %}
   </div>
</div>
{%  endif %}
</div>
{% endblock %}
