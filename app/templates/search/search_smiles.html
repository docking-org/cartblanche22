{% extends 'base.html' %}
{% block styles %}
    {{ super() }}
    <style>
        .mol {
            opacity: 1;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            padding: 10px;
        }

        .mol img {
            width: 100%;
            height: 15vh
        }

        .added {
            border: 1px solid #5bc0de;
            background-color: #9bd8eb;
        }
    </style>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script>
    </script>
    <script type="text/javascript">
        $('#exampleModal').on('hidden.bs.modal', function () {
            $('#myfile').val('')
        });

        $("form#data").submit(function (e) {

            $('#exampleModal').modal('show');
            $('#spinnerbody').html("<i class='fa fa-spinner fa-pulse fa-x fa-fw'></i> Searching...")
            $('#exampleModalLabel').html('Please wait...')
            e.preventDefault();
            var formData = new FormData();
            let file = $('#myfile')[0].files[0];
            let txtarea = $('#textareasmiles').val()
            let dist = $('#distformat').val()
            let adist = $('#adistformat').val()
            if (file === undefined) {
                {#console.log(txtarea)#}
                var theArray = txtarea.split();
                {#console.log(theArray)#}
                var oMyBlob = new Blob(theArray, {type: 'text/plain;charset=utf-8;'});
                formData.append('smiles-in', oMyBlob, 'search.txt');
                {#oMyBlob.text().then((e) =>{#}
                {#    console.log(e)})#}
            } else {
                formData.append('smiles-in', file);
            }
            formData.append('dist', dist);
            formData.append('adist', adist);
            {#        for (var pair of formData.entries()) {#}
            {#console.log(pair[0]+ ', ' + pair[1]);}#}
            {#$.ajax({#}
            {#    url: '/search/api',#}
            {#    type: 'GET',#}
            {#    success: function (response) {#}
            {#        console.log(response)#}
            {#        buildMol(response)#}
            {#    },#}
            {#    error: function (error) {#}
            {#        $('#exampleModalLabel').html("Error occured during search. Error code: " + error.status)#}
            {#        $('#spinnerbody').html("Search failed")#}
            {#    }});#}

            $.ajax({
                url: '/smiles.json',
                cache: false,
                contentType: false,
                processData: false,
                data: formData,
                type: 'POST',
                success: function (response) {
                    if (Object.keys(response).length === 0) {
                        $('#exampleModalLabel').html("Nothing found")
                        $('#spinnerbody').html("Your search value doesn't match with any molecules")
                    } else {
                        buildMol(response)
                    }
                    console.log(response)
                },
                statusCode: {
                    404: function (responseObject, textStatus, jqXHR) {
                        $('#exampleModalLabel').html("Nothing found")
                        $('#spinnerbody').html("Your search value doesn't match with any molecules")
                    },
                    400: function (responseObject, textStatus, errorThrown) {
                        $('#exampleModalLabel').html("Error occured during search. Error code: " + error.status)
                        $('#spinnerbody').html("Search failed")
                    }
                },
                error: function (error) {
                    $('#exampleModalLabel').html("Error occured during search. Error code: " + error.status)
                    $('#spinnerbody').html("Search failed")
                }
            });
        });

        function buildMol(response) {
            $('#desc').hide()
            $('#foundNum').html(response.length)
            $('#addAllBtn').click((e) => {
                console.log(response)
                let btn = $(e.target)
                if (btn.hasClass('addAllZinc')) {
                    btn.removeClass('addAllZinc')
                    btn.html("Add all to cart")
                    btn.removeClass('btn-danger')
                    btn.addClass('btn-info')
                    console.log('deleted all from cart')
                    for (let item of response) {
                        shoppingCart.removeItemFromCart(item.zinc_id)
                        $('#' + item.zinc_id).removeClass('added')
                    }
                } else {
                    btn.addClass('addAllZinc')
                    btn.html("Remove all from cart")
                    btn.removeClass('btn-info')
                    btn.addClass('btn-danger')
                    $('.zinc-results').addClass('addZinc')
                    console.log('added all to cart')
                    for (let item of response) {
                        shoppingCart.addItemToCart(item.zinc_id, 'zinc22', item.hitMappedSmiles)
                        $('#' + item.zinc_id).addClass('added')
                    }
                }
                $('#cartCount').html(shoppingCart.countCart())
            })
            for (let item of response) {

                $('#exampleModal').modal('hide');
                $('#searchInput').hide();
                $('#zincResults').show();
                $('#molResults').show();
                let div = $("<div>", {
                    class: "col-xs-6 col-sm-4 col-md-3 col-lg-2 col-xl-2"
                });
                let div2 = $("<div>", {
                    id: item.zinc_id,
                    class: "mol",
                    'data-smiles': item.hitMappedSmiles,
                    'data-db': 'zinc22'
                });
                let a = $("<a>", {href: "/searchZinc/" + item.zinc_id, text: item.zinc_id})
                let img = $("<img>", {src: "https://sw.docking.org/depict/svg?w=50&h=30h&smi=" + encodeURIComponent(item.hitMappedSmiles) + "&qry=%q&cols=%c&cmap=%m&bgcolor=clear&hgstyle=outerglow"})
                div2.append(a)
                div2.append(img)
                if (shoppingCart.inCart(item.zinc_id)) {
                    div2.addClass('added');
                }
                div2.click((e) => {
                    let cur = $(e.currentTarget);
                    console.log(e.currentTarget.id)
                    if (cur.hasClass('added')) {
                        shoppingCart.removeItemFromCart(cur.attr('id'))
                        cur.removeClass('added')
                    } else {
                        cur.addClass('added')
                        $.ajax({
                            url: 'https://cartblanche22.docking.org/search.json?zinc_id=' + cur.attr('id'),
                            cache: false,
                            contentType: false,
                            processData: false,
                            type: 'POST',
                            success: function (response) {
                                console.log(response)
                                console.log(response.supplier_code)
                                console.log(response.items.supplier_code)
                            },

                            error: function (error) {
                                {#console.log('calling zinc api from smile search', error)#}
                            },
                            complete: function (data) {
                                if (data.status != 404) {
                                    let suppliers = data.responseJSON.items[0].supplier_code

                                    shoppingCart.addItemToCart(cur.attr('id'), cur.data('db'), cur.data('smiles'), suppliers)

                                } else {
                                    shoppingCart.addItemToCart(cur.attr('id'), cur.data('db'), cur.data('smiles'))

                                }
                            },
                        });

                    }
                })
                div.append(div2)
                $('#molResults').append(div)
            }
            $('#downloadBtn').click((e) => {
                e.preventDefault();

                var blob = new Blob([JSON.stringify(response)], {
                    type: 'application/json'
                });
                saveAs(blob, "zincSearchResult.json")
            });
        }
    </script>
{% endblock %}
{% block app_content %}
    <div class="row" id="searchInput">
        <div class="panel panel-info">
            <div class="panel-heading">Search by Smiles</div>
            <div class="panel-body">
                <form id='data' action="/" method="post" class="form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="textareasmiles">One smile per Line</label>
                        <p>Test Data:
                            <br> C1CCC(-C2NNCNN2)CC1
                            <br>C1CCC(C2CNNC2)C1 <br> C1=CC=CC=C1C2=CC=CC=C2</p>

                        <textarea id="textareasmiles" class="form-control" name="list_of_smiles" rows="6" cols="20"
                                  placeholder="Smiles"></textarea>
                    </div>
                    <h5>OR Upload a File</h5>
                    <div class="form-group">
                        <label for="myfile">Select a file (.txt only):</label>
                        <input type="file" id="myfile" name="smiles_file" class="form-control" accept=".txt">
                    </div>
                    <label for="distformat">dist:</label>
                    <select name="dist" class="btn btn-info" id="distformat">
                        <option value="0" id="dist-0">
                            0
                        </option>
                        <option value="1" id="dist-1">
                            1
                        </option>
                        <option value="2" id="dist-2">
                            2
                        </option>
                        <option value="3" id="dist-3">
                            3
                        </option>
                        <option value="4" id="dist-4" selected>
                            4
                        </option>
                        <option value="5" id="dist-5">
                            5
                        </option>

                    </select>
                    <label for="adistformat">anon dist:</label>
                    <select name="adist" class="btn btn-info" id="adistformat">
                        <option value="0" id="adist-0">
                            0
                        </option>
                        <option value="1" id="adist-1">
                            1
                        </option>
                        <option value="2" id="adist-2">
                            2
                        </option>
                        <option value="3" id="adist-3">
                            3
                        </option>
                        <option value="4" id="adist-4" selected>
                            4
                        </option>
                        <option value="5" id="adist-5">
                            5
                        </option>

                    </select>
                    <button class="btn btn-info" type="submit" name="Search">
                        Search
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="row" id="zincResults" style="display: none">
        <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 col-xl-6">
            <button class="btn btn-info"><a href="{{ url_for('main.search_smiles') }}">Back</a></button>
            <h5>We found <span id="foundNum"></span> matches</h5>
        </div>
        <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 col-xl-6 pull-right">
            <button class="btn btn-info pull-right" onclick="" id="addAllBtn">
                Add all to cart
            </button>
            <button class="btn btn-info pull-right" name="Search" id="downloadBtn">
                Download <i class="fa fa-download fa-x" aria-hidden="true"></i>
            </button>
        </div>

    </div>
    <br>
    <div class="row" id="molResults" style="display: none">
    </div>
    <div class="row" id="desc">
        <h4>CURL commands for searching Smiles</h4>
        <p>Below curl command returns a file with all possible fields. </p>
        <p>to get .txt file: <code>
            curl https://cartblanche22.docking.org/smiles.txt -F smiles-in=@smiles.txt -F dist=4 -F adist=4
        </code>
        </p>

        <p>to get .json file: <code>
            curl https://cartblanche22.docking.org/smiles.json -F smiles-in=@smiles.txt -F dist=4 -F adist=4
        </code></p>
        <p>to get .csv file: <code>
            curl https://cartblanche22.docking.org/smiles.csv -F smiles-in=@smiles.txt -F dist=4 -F adist=4
        </code></p>
        <p>If you want to learn more about search, please go to <a
                href="http://wiki.docking.org/index.php/Zinc22:Searching" target="_blank"> Zinc22 documentation on wiki
            page</a></p>
    </div>
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h3 id="spinnerbody"><i class="fa fa-spinner fa-pulse fa-x fa-fw"></i> Searching...</h3>
                </div>
            </div>
        </div>
    </div>
{% endblock %}