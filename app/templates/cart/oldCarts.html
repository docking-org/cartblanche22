{% extends 'base.html' %}
{% block metas %}
<meta http-equiv="Content-Type" content="application/vnd.ms-excel; charset=utf-8" />
<meta http-equiv="Content-Disposition" content="attachment; filename=abc.xls" />

{% endblock %}
{% block scripts %}
{{ super() }}

<script>
    $(document).ready(function () {
        let activeCart = '{{ current_user.activeCart | tojson }}';
        $('#myTable').DataTable({
            dom: 'Bfrtip',
            buttons: [
                {
                    title: 'CartList',
                    extend: 'csvHtml5',
                    exportOptions: {
                        columns: [0, 1, 2]
                    }
                },
                {
                    title: 'CartList',
                    extend: 'excelHtml5',
                    exportOptions: {
                        columns: [0, 1, 2]
                    }
                },
                {
                    title: 'CartList',
                    extend: 'pdfHtml5',
                    exportOptions: {
                        columns: [0, 1, 2]
                    }
                },
                {
                    title: 'CartList',
                    text: 'TSV',
                    extend: 'csvHtml5',
                    fieldSeparator: '\t',
                    extension: '.tsv',
                    exportOptions: {
                        columns: [0, 1, 2]
                    }
                },
                //'colvis'
            ]
        });
        $("#cart_" + activeCart).attr('class', 'info')
        $("#delete_" + activeCart).prop('disabled', 'true')
    });
    function deleteCart(cart_id, count) {
        $.ajax({
            url: '/deleteCart/' + cart_id,
            type: 'DELETE',
            success: function (result) {
                console.log(result)
                location.reload();
                // Do something with the result
            }
        });

    }
    function save() {
        console.log(this.id)
        let new_name = $('#cartName').val();
        let cart_id = $('#cartName').attr('cart_id')
        $.ajax({
            type: "POST",
            url: '/renameCart',
            data: JSON.stringify({ 'name': new_name, 'cart_id': cart_id }),
            contentType: "application/json",
            dataType: 'json',
            success: (res) => {
                $('#cname_' + cart_id).html(new_name)
            }
        });
    }
    $(document).on("click", ".open-renameDialog", function () {
        $('#cartName').val($("#cname_" + this.id).html())
        $('#cartName').attr('cart_id', this.id)
    });
    $('#createCart').on('click'), () => {
        console.log('create cart clicked')
        let cart = []
        localStorage.setItem('cart', JSON.stringify(cart))
    }
    function activate(cart_id) {
        console.log('calling activate function');
        console.log('cart_id:' + cart_id);
        $.ajax({
            url: '/activateCart/' + cart_id,
            type: 'GET',
            success: function (result) {
                let id = $('.info').attr('id').split('_')[1]
                $("#cart_" + id).attr('class', 'even')
                $("#delete_" + id).removeAttr("disabled")
                $("#cart_" + cart_id).attr('class', 'info')
                $("#delete_" + cart_id).prop('disabled', 'true')
                console.log(result['data'])
                localStorage.setItem('cart', JSON.stringify(result['data']))
                localStorage.setItem('is_authenticated', 'True')
                // Do something with the result
            }
            /*
            let confirmed = window.confirm("Are you sure to delete this item from cart?")
            if (confirmed) {
                
                }
            */
        });
    }
</script>
{% endblock %}
{% block app_content %}
<div class="table-responsive">
    <h4>You have: {{carts|length}} carts <a href="{{url_for('main.createCart')}}" class="btn btn-info" role="button"
            id="createCart">+</a></h4>

    <table class="table table-striped table-hover" id="myTable">
        <thead>
            <tr>
                <th>Cart Name</th>
                <th>Number of items</th>
                <th>Total Price</th>
                <th>Status</th>
                <th>Utility</th>
            </tr>
        </thead>
        <tbody>
            {% for c in carts %}
            <tr id="cart_{{c.cart_id}}">
                <td id="cname_{{c.cart_id}}">{{c.name}}</td>
                <td>
                    {{c.count}}
                </td>
                <td>{{c.totalPrice}}</td>
                <td>{{c.status}}</td>
                <td>
                    <div class="btn-group" role="group" aria-label="hidden">
                        <button id="delete_{{c.cart_id}}" type="button" class="btn btn-info"
                            onclick="deleteCart('{{c.cart_id}}', '{{c.count}}')"><span class="glyphicon glyphicon-trash"
                                aria-hidden="true"></span></button>
                        <button type="button" class="open-renameDialog btn btn-info" id="{{c.cart_id}}"
                            data-toggle="modal" data-target="#myModal"><span class="glyphicon glyphicon-pencil"
                                aria-hidden="true"></span></button>
                        <button type="button" class="btn btn-info" onclick="activate('{{c.cart_id}}')">Activate</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th>Cart Name</th>
                <th>Number of items</th>
                <th>Total Price</th>
                <th>Status</th>
                <th>Utility</th>
            </tr>
        </tfoot>


    </table>
</div>
<div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Rename cart</h4>
            </div>
            <div class="modal-body">
                <input id="cartName" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="button" onclick="save()" class="btn btn-info" data-dismiss="modal">Save</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>

{% endblock %}