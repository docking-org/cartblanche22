{% extends 'base.html' %}
{% block styles %}
    {{ super() }}

    <style>
        .unassigned {
            background-color: #c5e9f4 !important;
            opacity: 80%;
        }

        table head {
            padding: 50px;
            font-size: 18px;
        }

        .mol-img {
            width: 100%;
            height: 10vh
        }
    </style>
{% endblock %}
{% block scripts %}
    {{ super() }}

    <script src="../static/js/custom/api.js"></script>
    <script src="../static/js/custom/cart.js"></script>
    <script src="../static/js/custom/cartblanche.js"></script>
    <script>
        $(document).ready(() => {
            setDefaultPrices();
            $('#total').html(shoppingCart.totalAmountCart())
            if (localStorage.getItem('checkCart') == "True") {
                cartCheck('{{is_authenticated}}', '{{cart|safe}}');
            }
            const table = $('#table').DataTable({
                "language": {
                    "emptyTable": "Cart is empty"
                },
                "scrollX": false,
                "scrollY": "550px",
                "paging": false,
                "ordering": false,
                "info": false,
                data: shoppingCart.listCart(),
                columns: [
                    {
                        "mData": null,
                    },
                    {
                        "mData": (data) => {
                            return '<img src="' + data.img + '" class="mol-img"/>';
                        },
                    },
                    {
                        "mData": function (data) {
                            if (data.db.includes('zinc22')) {
                                return "<a href='/searchZinc/" + data.identifier + "'><p id=''>" + data.identifier + "<br/>" + data.db + "</p></a>";
                            } else {
                                return "<a><p id='identifier'>" + data.identifier + "<br/>" + data.db + "</p></a>";
                            }
                        }
                    },
                    {
                        "mData": function (data) {
                            return data.cat_name + "<br/><small>" + data.supplier_code + "</small>";
                        }
                    },
                    {
                        "mData": function (data) {
                            return data.quantity + data.unit;
                        }
                    },
                    {data: "shipping"},
                    {
                        "mData": function (data) {
                            return '$' + data.price;
                        }
                    },
                    {data: "purchase"},
                    {
                        "mData": function (data) {
                            return '$' + data.total;
                        }
                    },
                    {
                        data: null,
                        defaultContent: '<a id="delete" ><span class="glyphicon glyphicon-trash btn btn-info btn-sm" aria-hidden="true"></span></a>'
                    },
                ],
                "columnDefs": [
                    {
                        "targets": 7,
                        "data": "purchase",
                        "render": function (data, type, full, meta) {
                            var $select = $("<select></select>", {});
                            for (let i = 1; i <= 10; i++) {
                                var $option = $("<option></option>", {
                                    "text": i,
                                    "value": i
                                });
                                if (data == i) {
                                    $option.attr("selected", "selected")
                                }
                                $select.append($option);
                            }
                            return $select.prop("outerHTML");
                        }
                    },

                ],
                rowCallback: function (row, data) {

                    if (data['cat_name'] == 'not assigned') {
                        $(row).addClass("unassigned")
                    }

                }

            });
            table.on('order.dt search.dt change click', function () {
                table.column(0, {search: 'applied', order: 'applied'}).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            }).draw();
            $('#table').on("click", "#delete", function () {
                let data = table.row($(this).parents('tr')).data()
                shoppingCart.removeItemFromCart(data.identifier)
                table.row($(this).parents('tr')).remove().draw(false);
                updateCartNums();
            });
            $('#table').on('change', 'select', function () {
                let new_purchase = $(this).context.value
                let data = table.row($(this).parents('tr')).data()
                if (data['cat_name'] != 'not assigned') {
                    shoppingCart.updatePurchaseAmount(data.identifier, data.cat_name, data.supplier_code, data.quantity, data.unit, data.price, new_purchase);
                    updateCartNums();
                    data.purchase = new_purchase
                    data.total = parseInt(data.price) * parseInt(new_purchase)
                    console.log(data)
                    table.row($(this).parents('tr')).data(data);

                }

            })
            $('#table').on("click", '#item', function () {
                let data = table.row($(this).parents('tr')).data()
            })

            {#$('#table').on("click", "#identifier", function () {#}
            {#    let data = table.row($(this).parents('tr')).data()#}
            {#    console.log(data)#}
            {#             $.ajax({#}
            {#        type: "POST",#}
            {#        url: "/processItem",#}
            {#        data: JSON.stringify(data),#}
            {#        contentType: "application/json",#}
            {#        dataType: 'json',#}
            {#        success: function (data) {#}
            {#            var route = data.result;#}
            {#            console.log(route);#}
            {#            window.location.href = route;#}
            {#        }#}
            {#    }); });#}

            $('#deleteAll').on('click', () => {
                shoppingCart.deleteAllFromCart();
                table.clear().draw();
            });
        });
        $('#checkout').on('click', () => {
            console.log('checkout button clicked')
            let cart = JSON.parse(localStorage.getItem('cart'))
            let total = $('#total').html()
            console.log(cart)
            $.ajax({
                type: "POST",
                url: "/processCheckout",
                data: JSON.stringify({'cart': cart, 'total': total}),
                contentType: "application/json",
                dataType: 'json',
                success: function (route) {
                    window.location.href = route;
                }
            });
        })
        $('#reassign').on('click', () => {
            $('#loadingModal').modal('show');
            let cart = shoppingCart.getCart()
            let apiCalled = false;
            for (let c = 0; c < cart.length; c++) {
                if (cart[c].supplier.length == 0) {
                    apiCalled = true;
                    $.ajax({
                        url: 'https://cartblanche22.docking.org/search.json?zinc_id=' + cart[c].identifier,
                        cache: false,
                        contentType: false,
                        processData: false,
                        type: 'POST',
                        success: function (response) {
                            console.log('got response for ', cart[c].identifier)
                            console.log(response.items[0])
                        },

                        error: function (error) {
                            {#console.log('calling zinc api from smile search', error)#}
                        },
                        complete: function (data) {
                            if (data.status != 404) {
                                let suppliers = data.responseJSON.items[0].supplier_code
                                let catalogs = data.responseJSON.items[0].catalogs
                                shoppingCart.assignvendors(cart[c].identifier, suppliers, catalogs)
                            }
                        },
                    });
                }
            }
            if (apiCalled) {
                $(document).ajaxStop(function () {
                    location.reload();
                });
            } else {
                $('#loadingModal').modal('hide');
            }


        });
        $('#refresh').on('click', () => {
            $('#loadingModal').modal('show');
            let cart = shoppingCart.getCart()
            for (let c = 0; c < cart.length; c++) {
                $.ajax({
                    url: 'https://cartblanche22.docking.org/search.json?zinc_id=' + cart[c].identifier,
                    cache: false,
                    contentType: false,
                    processData: false,
                    type: 'POST',
                    error: function (error) {
                    },
                    complete: function (data) {
                        if (data.status != 404) {
                            let suppliers = data.responseJSON.items[0].supplier_code
                            let catalogs = data.responseJSON.items[0].catalogs
                            shoppingCart.assignvendors(cart[c].identifier, suppliers, catalogs)
                        }
                    },
                });

            }
            $(document).ajaxStop(function () {
                $('#loadingModal').modal('hide');
                location.reload();

            });


        });

    </script>
{% endblock %}


{% block app_content %}
    <div class="row">
        <div class="col-md-6">
            <h1>Shopping Cart</h1>
            {#        <p>(Click on the identifier to assign vendor)</p>#}
        </div>

        <div class="col-md-6 float-right text-right">
            <h5 class="card-title" id='checkoutTitle'>Total : $<span id='total'>-</span></h5>
            <button type="button" class="btn btn-info"
                    id="refresh"
                    title="Throw away all assigned vendors then assign new vendors"
                    data-toggle="tooltip" data-placement="up">
                Refresh Vendors
            </button>
            <button type="button" class="btn btn-info"
                    id="reassign"
                    title="Assign vendors for unassigned molecules"
                    data-toggle="tooltip" data-placement="up">
                Assign Vendors
            </button>
            <button type="button" class="btn btn-info" id="checkout">Checkout</button>
            <button type="button" class="btn btn-warning" id="deleteAll">Clear cart</button>
        </div>
    </div>
    <hr>
    <div>

    </div>
    <table id="table" class="row-border " cellspacing="0" style="width:100%;">
        <thead>
        <tr>
            <th>No</th>
            <th>Compound image</th>
            <th>
                Identifier<br><small>Database</small>
            </th>
            <th>
                Catalog Name<br><small>Supplier Code</small>
            </th>
            <th>Pack size</th>
            <th>Shipping time</th>
            <th>Pack price</th>
            <th>Purchase qty</th>
            <th>Total price</th>

            <th></th>
        </tr>
        </thead>
    </table>
    <div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h3 id="spinnerbody"><i class="fa fa-spinner fa-pulse fa-x fa-fw"></i> We are working on it ...
                    </h3>
                </div>
            </div>
        </div>
    </div>
{% endblock %}