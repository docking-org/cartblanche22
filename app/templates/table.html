{%  extends 'base.html' %}
{%  block content %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<style>
    table,
    th,
    td {
        border: 1px solid black;
        padding: 8px;
    }

    table {
        border-collapse: collapse;
    }


    body {
        font-family: Arial, Helvetica, sans-serif;
    }

    button,
    .button {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 12px;
        margin: 2px 2px;
        cursor: pointer;
    }

    /* The Modal (background) */
    .modal {
        display: none;
        /* Hidden by default */
        position: fixed;
        /* Stay in place */
        z-index: 1;
        /* Sit on top */
        padding-top: 100px;
        /* Location of the box */
        left: 0;
        top: 0;
        width: 100%;
        /* Full width */
        height: 100%;
        /* Full height */
        overflow: auto;
        /* Enable scroll if needed */
        background-color: rgb(0, 0, 0);
        /* Fallback color */
        background-color: rgba(0, 0, 0, 0.4);
        /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }

    /* The Close Button */
    .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }
</style>



<a href="{{url_for('main.tsv')}}"><button>Export .tsv</button></a>
<button>Export2</button>
<table>
    <tr>
        <th>No</th>
        <th>Compound</th>
        <th>Identifier</th>
        <th>Database</th>
        <th>Suppliers</th>
        <th>Total Quantity</th>
        <th>Total Price</th>
        <th>Utility</th>
    </tr>
    {% for i in data %}
    <tr>
        <td>{{ loop.index }}</td>
        <td><img src={{ i.compound_img }}></td>
        <td>{{ i.identifier }}</td>
        <td> {{ i.database }}</td>

        <td>
            {% for v in i.vendors %}
            <ul>
                <li>{{v.company_name}}--each pack has {{v.pack_quantity}}{{v.unit}} for {{v.price}}{{v.currency}}
                    added
                    {{v.purchase_quantity}} pack
                </li>
            </ul>
            {% endfor %}
        </td>
        <!-- <td>{{quantities[loop.index-1]}}</td> -->
        <!-- <td>{{prices[loop.index-1]}}</td> -->
        <td></td>
        <td></td>
        <td>
            <!-- <button id={{i.id}} onclick='deleteItem(this)'> Delete </button> -->
            <form action="{{ url_for('main.deleteItem', item_id=i.item_id) }}" method=post>
                <input type=submit value=Delete class="button">
            </form>

            <button id={{i.item_id}} identifier={{i.identifier}} onclick="openModal(this)">Update
                Vendor</button>

            {#                <button identifier={{i.identifier}} onclick='getVendors(this)'> Update Vendor </button>#}
            <!-- <button identifier={{i.identifier}} onclick='duplicate(this)'> Duplicate </button> -->
        </td>
    </tr>

    {% endfor %}

</table>
<div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id='tableDiv'></div>
        <a href="{{url_for('main.cart')}}"><button>Choose</button></a>
    </div>


</div>
<script>
    var modal = document.getElementById("myModal");
    var span = document.getElementsByClassName("close")[0];
    span.onclick = function (e) {
        modal.style.display = "none";
        location.reload();
    }
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
            location.reload();
        }
    }
    function openModal(b) {
        $.getJSON('/vendorModal/' + b.id,
            function (res) {
                let table_body = '<table><tr><th>No</th><th>Company name</th>';
                table_body += '<th>Supplier code</th>'
                    + '<th>Delivery time</th><th>Price</th><th>Pack Size</th><th>Quantity</th></tr>'

                for (let i = 0; i < res.length; i++) {
                    let len = res[i].packs.length
                    for (let p = 0; p < len; p++) {
                        table_body += '<tr>'
                        if (p == 0) {
                            table_body += '<td rowspan=' + len + '>' + (i + 1) + '</td>';
                            table_body += '<td rowspan=' + len + '>' + res[i].cat_name + '</td>';
                            table_body += '<td rowspan=' + len + '>' + res[i].supplier_code + '</td>';
                        }
                        let pack = res[i].packs[p]
                        table_body += '<td>' + pack.shipping + '</td>';
                        table_body += '<td>' + pack.price + ' ' + pack.currency + '</td>';
                        table_body += '<td>' + pack.quantity + ' ' + pack.unit + '</td>';
                        if (pack.price != 'POA' || pack.quantity != 'NA') {
                            table_body += "<td><input type=number id=" + b.id
                                + " name= " + res[i].supplier_code
                                + ',' + res[i].cat_name
                                + "," + pack.price
                                + "," + pack.currency
                                + "," + pack.quantity
                                + "," + pack.unit
                                + "," + res[i].cat_id_fk
                                + " value=" + pack.purchase_quantity
                                + " onchange='vendorUpdate(this)' max=10>"
                                + '</td>';
                        }
                        table_body += '</tr>'
                    }

                }
                table_body += '</table>';
                $('#tableDiv').html(table_body);
                modal.style.display = "block";
            });
        return false;
    }
    function vendorUpdate(input) {
        $.getJSON('/vendorUpdate', {
            'item_id': input.id,
            'value': input.value,
            'data': input.name
        },
            function (res) {
                console.log(res)
            });
        return false;
    }

</script>


{%  endblock %}